<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locomotive Database - DCC Layout Control</title>
    <script src="js/config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .user-header {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            font-weight: 600;
        }
        
        .user-role {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .role-admin { background: #e74c3c; }
        .role-operator { background: #f39c12; }
        .role-viewer { background: #95a5a6; }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #b0b0b0;
            margin-bottom: 30px;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-link {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            margin: 0 10px;
            display: inline-block;
        }
        
        .nav-link:hover {
            background-color: #45a049;
        }
        
        .controls-bar {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }
        
        .search-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .controls-bar input, .controls-bar select {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #404040;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .controls-bar input:focus, .controls-bar select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #45a049;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .locomotives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .loco-card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .loco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .loco-image {
            width: 100%;
            height: 200px;
            background-color: #404040;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .loco-image.no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 48px;
        }
        
        .dcc-address-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .loco-info {
            padding: 15px;
        }
        
        .loco-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .loco-name {
            color: #f39c12;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .loco-details {
            display: grid;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .detail-label {
            color: #b0b0b0;
        }
        
        .detail-value {
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .loco-type-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .type-steam { background-color: #8b4513; color: white; }
        .type-diesel { background-color: #ff7f00; color: white; }
        .type-electric { background-color: #1e90ff; color: white; }
        .type-multiple_unit { background-color: #9932cc; color: white; }
        
        .sound-badge {
            background-color: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .functions-display {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-top: 10px;
        }
        
        .function-badge {
            background-color: #6c757d;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .loco-actions {
            padding: 0 15px 15px 15px;
            display: flex;
            gap: 10px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #555;
            background-color: #404040;
            color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: #4CAF50;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: #2d2d2d;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        
        .modal-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: bold;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #404040;
            color: #e0e0e0;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .functions-editor {
            margin-top: 10px;
        }
        
        .function-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
        }
        
        .function-row input {
            flex: 1;
        }
        
        .function-row button {
            padding: 4px 8px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .error {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .warning {
            background-color: #ffc107;
            color: #212529;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #b0b0b0;
        }
        
        .no-data {
            text-align: center;
            color: #b0b0b0;
            padding: 40px;
            background-color: #2d2d2d;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .locomotives-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="user-header">
        <div class="user-info">
            <span class="user-name" id="userName">Loading...</span>
            <span class="user-role" id="userRole"></span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="main-content">
        <div class="container">
            <h1>🚂 Locomotive Database</h1>
            <p class="subtitle">Manage your DCC locomotive collection</p>
            
            <div class="navigation">
                <a href="dashboard.html" class="nav-link">📊 Dashboard</a>
                <a href="monitor.html" class="nav-link">📺 Monitor</a>
                <a href="stations.html" class="nav-link">🚉 Stations</a>
                <a href="station_connections.html" class="nav-link">🔗 Connections</a>
                <a href="station_tracks.html" class="nav-link">🛤️ Tracks</a>
            </div>
            
            <div class="controls-bar">
                <div class="search-filters">
                    <input type="text" id="searchInput" placeholder="Search locomotives..." style="min-width: 200px;">
                    <select id="manufacturerFilter">
                        <option value="">All Manufacturers</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="steam">Steam</option>
                        <option value="diesel">Diesel</option>
                        <option value="electric">Electric</option>
                        <option value="multiple_unit">Multiple Unit</option>
                    </select>
                    <select id="railwayFilter">
                        <option value="">All Railways</option>
                    </select>
                    <select id="eraFilter">
                        <option value="">All Eras</option>
                        <option value="I">Era I</option>
                        <option value="II">Era II</option>
                        <option value="III">Era III</option>
                        <option value="IV">Era IV</option>
                        <option value="V">Era V</option>
                        <option value="VI">Era VI</option>
                    </select>
                    <label class="checkbox-group">
                        <input type="checkbox" id="soundOnlyFilter">
                        <span>Sound only</span>
                    </label>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showAddModal()" id="addLocomotiveBtn">➕ Add Locomotive</button>
                    <button class="btn btn-secondary" onclick="loadLocomotives()">🔄 Refresh</button>
                </div>
            </div>
            
            <div id="locomotivesGrid" class="locomotives-grid">
                <div class="loading">Loading locomotives...</div>
            </div>
            
            <div class="pagination" id="pagination"></div>
            
            <div id="errorMessage"></div>
        </div>
    </div>
    
    <!-- Add/Edit Locomotive Modal -->
    <div id="locomotiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Add Locomotive</span>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="locomotiveForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="dccAddress">DCC Address *</label>
                        <input type="number" id="dccAddress" name="dcc_address" min="1" max="10239" required>
                    </div>
                    <div class="form-group">
                        <label for="class">Class *</label>
                        <input type="text" id="class" name="class" placeholder="e.g., BR 101, ICE 3" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="number">Number *</label>
                        <input type="text" id="number" name="number" placeholder="e.g., 101 001-4" required>
                    </div>
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" name="name" placeholder="e.g., Deutschland">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pictureFile">Picture Upload</label>
                    <input type="file" id="pictureFile" name="picture" accept="image/*">
                    <small style="color: #888;">Supported formats: JPEG, PNG, GIF, WebP (max 5MB)</small>
                    <div id="picturePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 4px;" />
                        <button type="button" id="removePicture" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="manufacturer">Manufacturer</label>
                        <input type="text" id="manufacturer" name="manufacturer" placeholder="e.g., Märklin, Roco">
                    </div>
                    <div class="form-group">
                        <label for="scale">Scale</label>
                        <select id="scale" name="scale">
                            <option value="H0">H0</option>
                            <option value="N">N</option>
                            <option value="TT">TT</option>
                            <option value="Z">Z</option>
                            <option value="1">Scale 1</option>
                            <option value="G">G</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="era">Era</label>
                        <select id="era" name="era">
                            <option value="">Select Era</option>
                            <option value="I">Era I (1835-1920)</option>
                            <option value="II">Era II (1920-1945)</option>
                            <option value="III">Era III (1945-1970)</option>
                            <option value="IV">Era IV (1970-1990)</option>
                            <option value="V">Era V (1990-2006)</option>
                            <option value="VI">Era VI (2006+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" name="country" placeholder="e.g., DE, CH, AT" maxlength="3">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="railwayCompany">Railway Company</label>
                        <input type="text" id="railwayCompany" name="railway_company" placeholder="e.g., DB, SBB, ÖBB">
                    </div>
                    <div class="form-group">
                        <label for="locomotiveType">Type</label>
                        <select id="locomotiveType" name="locomotive_type">
                            <option value="electric">Electric</option>
                            <option value="diesel">Diesel</option>
                            <option value="steam">Steam</option>
                            <option value="multiple_unit">Multiple Unit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxSpeed">Max Speed (km/h)</label>
                        <input type="number" id="maxSpeed" name="max_speed_kmh" min="0" max="500">
                    </div>
                    <div class="form-group">
                        <label for="length">Length (mm)</label>
                        <input type="number" id="length" name="length_mm" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="decoderType">Decoder Type</label>
                        <input type="text" id="decoderType" name="decoder_type" placeholder="e.g., mSD3, LokSound 5">
                    </div>
                    <div class="form-group">
                        <label for="decoderManufacturer">Decoder Manufacturer</label>
                        <input type="text" id="decoderManufacturer" name="decoder_manufacturer" placeholder="e.g., ESU, Märklin">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-group">
                            <input type="checkbox" id="soundDecoder" name="sound_decoder">
                            <span>Sound Decoder</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="functionsCount">Functions Count</label>
                        <input type="number" id="functionsCount" name="functions_count" min="0" max="32" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Function Mapping</label>
                    <div id="functionsEditor" class="functions-editor">
                        <!-- Function mappings will be added dynamically -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addFunction()">Add Function</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="purchaseDate">Purchase Date</label>
                        <input type="date" id="purchaseDate" name="purchase_date">
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice">Purchase Price</label>
                        <input type="number" id="purchasePrice" name="purchase_price" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="turnaroundTime">Turnaround Time (minutes)</label>
                    <input type="number" id="turnaroundTime" name="turnaround_time_minutes" min="1" max="120" value="10" title="Minimum time required between consecutive train assignments">
                    <small style="color: #95a5a6; font-size: 0.8rem;">Minimum time in minutes required between consecutive train assignments for this locomotive</small>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="isActive" name="is_active" checked>
                        <span>Active</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Locomotive</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let locomotives = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentUser = null;
        let editingLocomotive = null;
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            await loadLocomotives();
            await loadFilterOptions();
            setupEventListeners();
        });
        
        async function checkAuth() {
            try {
                const response = await fetch('auth_api.php?action=validate');
                const result = await response.json();
                
                if (result.status === 'success' && result.data.valid) {
                    const profileResponse = await fetch('auth_api.php?action=profile');
                    const profileResult = await profileResponse.json();
                    
                    if (profileResult.status === 'success') {
                        currentUser = profileResult.data;
                        updateUserHeader();
                        updatePermissions();
                        return true;
                    }
                }
                
                currentUser = null;
                updateUserHeader();
                updatePermissions();
                return false;
            } catch (error) {
                console.error('Auth check error:', error);
                currentUser = null;
                updateUserHeader();
                updatePermissions();
                return false;
            }
        }
        
        function updateUserHeader() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const logoutBtn = document.querySelector('.logout-btn');
            
            if (currentUser) {
                const userName = currentUser.first_name && currentUser.last_name 
                    ? `${currentUser.first_name} ${currentUser.last_name}` 
                    : currentUser.username;
                userNameElement.textContent = userName;
                
                userRoleElement.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                userRoleElement.className = `user-role role-${currentUser.role}`;
                
                logoutBtn.style.display = 'block';
                logoutBtn.textContent = 'Logout';
                logoutBtn.onclick = logout;
            } else {
                userNameElement.textContent = 'Guest User';
                userRoleElement.textContent = 'View Only';
                userRoleElement.className = 'user-role role-viewer';
                
                logoutBtn.style.display = 'block';
                logoutBtn.textContent = 'Login';
                logoutBtn.onclick = () => window.location.href = 'login.html';
            }
        }
        
        function updatePermissions() {
            const canEdit = currentUser && ['admin', 'operator'].includes(currentUser.role);
            
            document.getElementById('addLocomotiveBtn').style.display = canEdit ? 'inline-block' : 'none';
            
            // Update action buttons in cards when they're rendered
            setTimeout(() => {
                const editButtons = document.querySelectorAll('.edit-btn');
                const deleteButtons = document.querySelectorAll('.delete-btn');
                
                editButtons.forEach(btn => btn.style.display = canEdit ? 'inline-block' : 'none');
                deleteButtons.forEach(btn => btn.style.display = (currentUser && currentUser.role === 'admin') ? 'inline-block' : 'none');
            }, 100);
        }
        
        async function logout() {
            try {
                await fetch('auth_api.php?action=logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                window.location.href = 'login.html';
            }
        }
        
        function setupEventListeners() {
            // Search and filter inputs
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('manufacturerFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('railwayFilter').addEventListener('change', applyFilters);
            document.getElementById('eraFilter').addEventListener('change', applyFilters);
            document.getElementById('soundOnlyFilter').addEventListener('change', applyFilters);
            
            // Form submission
            document.getElementById('locomotiveForm').addEventListener('submit', handleFormSubmit);
            
            // Functions count change
            document.getElementById('functionsCount').addEventListener('change', updateFunctionsEditor);
            
            // Picture file input
            document.getElementById('pictureFile').addEventListener('change', handlePicturePreview);
            document.getElementById('removePicture').addEventListener('click', removePicturePreview);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function loadLocomotives() {
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 20,
                    search: document.getElementById('searchInput').value,
                    manufacturer: document.getElementById('manufacturerFilter').value,
                    locomotive_type: document.getElementById('typeFilter').value,
                    railway_company: document.getElementById('railwayFilter').value,
                    era: document.getElementById('eraFilter').value,
                    sound_only: document.getElementById('soundOnlyFilter').checked ? '1' : '',
                    active_only: '1'
                });
                
                const response = await apiFetch(`locomotives_api.php?action=list&${params}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    locomotives = result.data;
                    totalPages = result.pagination.pages;
                    renderLocomotives();
                    renderPagination();
                    updatePermissions();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading locomotives:', error);
                showError('Error loading locomotives: ' + error.message);
            }
        }
        
        async function loadFilterOptions() {
            try {
                const response = await apiFetch('locomotives_api.php?action=list&limit=1000');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const locomotives = result.data;
                    
                    // Get unique values for filters
                    const manufacturers = [...new Set(locomotives.map(l => l.manufacturer).filter(m => m))].sort();
                    const railways = [...new Set(locomotives.map(l => l.railway_company).filter(r => r))].sort();
                    
                    // Populate manufacturer filter
                    const manufacturerSelect = document.getElementById('manufacturerFilter');
                    manufacturers.forEach(manufacturer => {
                        const option = document.createElement('option');
                        option.value = manufacturer;
                        option.textContent = manufacturer;
                        manufacturerSelect.appendChild(option);
                    });
                    
                    // Populate railway filter
                    const railwaySelect = document.getElementById('railwayFilter');
                    railways.forEach(railway => {
                        const option = document.createElement('option');
                        option.value = railway;
                        option.textContent = railway;
                        railwaySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }
        
        function renderLocomotives() {
            const container = document.getElementById('locomotivesGrid');
            
            if (locomotives.length === 0) {
                container.innerHTML = '<div class="no-data">No locomotives found matching the current filters</div>';
                return;
            }
            
            container.innerHTML = locomotives.map(loco => `
                <div class="loco-card">
                    <div class="loco-image ${loco.has_picture ? '' : 'no-image'}" 
                         ${loco.has_picture ? `style="background-image: url('locomotives_api.php?action=picture&id=${loco.id}')"` : ''}>
                        ${!loco.has_picture ? '🚂' : ''}
                        <div class="dcc-address-badge">#${loco.dcc_address}</div>
                    </div>
                    <div class="loco-info">
                        <div class="loco-title">${loco.class} ${loco.number}</div>
                        ${loco.name ? `<div class="loco-name">"${loco.name}"</div>` : ''}
                        <div class="loco-details">
                            ${loco.manufacturer ? `
                                <div class="detail-row">
                                    <span class="detail-label">Manufacturer:</span>
                                    <span class="detail-value">${loco.manufacturer}</span>
                                </div>
                            ` : ''}
                            ${loco.railway_company ? `
                                <div class="detail-row">
                                    <span class="detail-label">Railway:</span>
                                    <span class="detail-value">${loco.railway_company}</span>
                                </div>
                            ` : ''}
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="loco-type-badge type-${loco.locomotive_type}">${loco.locomotive_type.replace('_', ' ').toUpperCase()}</span>
                            </div>
                            ${loco.era ? `
                                <div class="detail-row">
                                    <span class="detail-label">Era:</span>
                                    <span class="detail-value">${loco.era}</span>
                                </div>
                            ` : ''}
                            ${loco.max_speed_kmh ? `
                                <div class="detail-row">
                                    <span class="detail-label">Max Speed:</span>
                                    <span class="detail-value">${loco.max_speed_kmh} km/h</span>
                                </div>
                            ` : ''}
                            ${loco.sound_decoder === true || loco.sound_decoder === 1 || loco.sound_decoder === '1' ? '<div class="sound-badge">🔊 Sound</div>' : ''}
                        </div>
                        ${loco.function_mapping && Object.keys(loco.function_mapping).length > 0 ? `
                            <div class="functions-display">
                                ${Object.entries(loco.function_mapping).map(([func, desc]) => 
                                    `<span class="function-badge">${func}: ${desc}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="loco-actions">
                        <button class="btn btn-secondary schedule-btn" onclick="viewLocomotiveSchedule(${loco.id}, '${loco.class} ${loco.number}')">📅 Schedule</button>
                        <button class="btn btn-secondary edit-btn" onclick="editLocomotive(${loco.id})">✏️ Edit</button>
                        <button class="btn btn-danger delete-btn" onclick="deleteLocomotive(${loco.id}, '${loco.class} ${loco.number}')">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderPagination() {
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let pagination = '';
            
            // Previous button
            pagination += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">« Previous</button>`;
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pagination += `<button class="${i === currentPage ? 'current-page' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // Next button
            pagination += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next »</button>`;
            
            container.innerHTML = pagination;
        }
        
        function changePage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                loadLocomotives();
            }
        }
        
        function applyFilters() {
            currentPage = 1;
            loadLocomotives();
        }
        
        function showAddModal() {
            if (!currentUser || !['admin', 'operator'].includes(currentUser.role)) {
                showError('You need to be logged in as an operator or admin to add locomotives');
                return;
            }
            
            editingLocomotive = null;
            document.getElementById('modalTitle').textContent = 'Add Locomotive';
            document.getElementById('locomotiveForm').reset();
            document.getElementById('isActive').checked = true;
            
            // Reset picture preview
            document.getElementById('picturePreview').style.display = 'none';
            document.getElementById('removePicture').onclick = removePicturePreview;
            
            updateFunctionsEditor();
            document.getElementById('locomotiveModal').style.display = 'block';
        }
        
        function viewLocomotiveSchedule(locomotiveId, locomotiveName) {
            // Open locomotive schedule in a new window/tab
            const url = `locomotive_schedule.html?id=${locomotiveId}&name=${encodeURIComponent(locomotiveName)}`;
            window.open(url, '_blank');
        }
        
        async function editLocomotive(id) {
            if (!currentUser || !['admin', 'operator'].includes(currentUser.role)) {
                showError('You need to be logged in as an operator or admin to edit locomotives');
                return;
            }
            
            try {
                const response = await apiFetch(`locomotives_api.php?action=get&id=${id}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    editingLocomotive = result.data;
                    document.getElementById('modalTitle').textContent = 'Edit Locomotive';
                    
                    // Fill form with locomotive data
                    Object.keys(result.data).forEach(key => {
                        const element = document.querySelector(`[name="${key}"]`);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = result.data[key] == 1;
                            } else {
                                element.value = result.data[key] || '';
                            }
                        }
                    });
                    
                    // Handle existing picture preview
                    const preview = document.getElementById('picturePreview');
                    const previewImage = document.getElementById('previewImage');
                    if (result.data.has_picture) {
                        previewImage.src = `locomotives_api.php?action=picture&id=${id}`;
                        preview.style.display = 'block';
                        
                        // Update remove button to delete from database
                        const removeBtn = document.getElementById('removePicture');
                        removeBtn.onclick = async function() {
                            try {
                                const deleteResponse = await fetch(`locomotives_api.php?action=delete_picture&id=${id}`, {
                                    method: 'DELETE'
                                });
                                const deleteResult = await deleteResponse.json();
                                if (deleteResult.status === 'success') {
                                    preview.style.display = 'none';
                                    showSuccess('Picture removed successfully');
                                } else {
                                    showError('Failed to remove picture: ' + deleteResult.error);
                                }
                            } catch (error) {
                                showError('Error removing picture: ' + error.message);
                            }
                        };
                    } else {
                        preview.style.display = 'none';
                        // Reset remove button to just clear preview
                        document.getElementById('removePicture').onclick = removePicturePreview;
                    }
                    
                    updateFunctionsEditor();
                    document.getElementById('locomotiveModal').style.display = 'block';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading locomotive:', error);
                showError('Error loading locomotive: ' + error.message);
            }
        }
        
        async function deleteLocomotive(id, name) {
            if (!currentUser || currentUser.role !== 'admin') {
                showError('You need to be logged in as an admin to delete locomotives');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete locomotive "${name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`locomotives_api.php?action=delete&id=${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('Locomotive deleted successfully');
                    loadLocomotives();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error deleting locomotive:', error);
                showError('Error deleting locomotive: ' + error.message);
            }
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {};
            
            // Convert form data to object (excluding the file)
            for (let [key, value] of formData.entries()) {
                if (key !== 'picture' && value !== '') {
                    data[key] = value;
                }
            }
            
            // Convert checkboxes
            data.sound_decoder = document.getElementById('soundDecoder').checked;
            data.is_active = document.getElementById('isActive').checked;
            
            // Collect function mapping
            const functionMapping = {};
            const functionRows = document.querySelectorAll('.function-row');
            functionRows.forEach(row => {
                const funcInput = row.querySelector('.function-key');
                const descInput = row.querySelector('.function-desc');
                if (funcInput.value && descInput.value) {
                    functionMapping[funcInput.value] = descInput.value;
                }
            });
            
            if (Object.keys(functionMapping).length > 0) {
                data.function_mapping = functionMapping;
            }
            
            try {
                let locomotiveId;
                
                // First save/update the locomotive data
                const url = editingLocomotive 
                    ? `locomotives_api.php?action=update&id=${editingLocomotive.id}`
                    : 'locomotives_api.php?action=create';
                
                const response = await apiFetch(url, {
                    method: editingLocomotive ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status !== 'success') {
                    throw new Error(result.error);
                }
                
                locomotiveId = editingLocomotive ? editingLocomotive.id : result.id;
                
                // Handle picture upload if a file was selected
                const pictureFile = document.getElementById('pictureFile').files[0];
                if (pictureFile) {
                    const pictureFormData = new FormData();
                    pictureFormData.append('picture', pictureFile);
                    pictureFormData.append('id', locomotiveId);
                    
                    const pictureResponse = await apiFetch('locomotives_api.php?action=upload_picture', {
                        method: 'POST',
                        body: pictureFormData
                    });
                    
                    const pictureResult = await pictureResponse.json();
                    if (pictureResult.status !== 'success') {
                        console.warn('Picture upload failed:', pictureResult.error);
                        showWarning('Locomotive saved but picture upload failed: ' + pictureResult.error);
                    }
                }
                
                showSuccess(editingLocomotive ? 'Locomotive updated successfully' : 'Locomotive created successfully');
                closeModal();
                loadLocomotives();
                
            } catch (error) {
                console.error('Error saving locomotive:', error);
                showError('Error saving locomotive: ' + error.message);
            }
        }
        
        function updateFunctionsEditor() {
            const count = parseInt(document.getElementById('functionsCount').value) || 0;
            const container = document.getElementById('functionsEditor');
            
            // Clear existing functions
            container.innerHTML = '';
            
            if (count === 0) return;
            
            // Create function rows
            for (let i = 0; i < count; i++) {
                const row = document.createElement('div');
                row.className = 'function-row';
                
                const existingMapping = editingLocomotive?.function_mapping || {};
                const functionKey = `F${i}`;
                const existingDesc = existingMapping[functionKey] || '';
                
                row.innerHTML = `
                    <input type="text" class="function-key" value="${functionKey}" placeholder="F0, F1...">
                    <input type="text" class="function-desc" value="${existingDesc}" placeholder="Function description">
                    <button type="button" onclick="removeFunction(this)">Remove</button>
                `;
                
                container.appendChild(row);
            }
        }
        
        function addFunction() {
            const container = document.getElementById('functionsEditor');
            const row = document.createElement('div');
            row.className = 'function-row';
            
            row.innerHTML = `
                <input type="text" class="function-key" placeholder="F0, F1...">
                <input type="text" class="function-desc" placeholder="Function description">
                <button type="button" onclick="removeFunction(this)">Remove</button>
            `;
            
            container.appendChild(row);
        }
        
        function removeFunction(button) {
            button.parentElement.remove();
        }
        
        function closeModal() {
            document.getElementById('locomotiveModal').style.display = 'none';
            editingLocomotive = null;
        }
        
        function showError(message) {
            const container = document.getElementById('errorMessage');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function showSuccess(message) {
            const container = document.getElementById('errorMessage');
            container.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }
        
        function showWarning(message) {
            const container = document.getElementById('errorMessage');
            container.innerHTML = `<div class="warning">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function handlePicturePreview(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('picturePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showError('Please select a valid image file');
                    event.target.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('File size must be less than 5MB');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }
        
        function removePicturePreview() {
            document.getElementById('pictureFile').value = '';
            document.getElementById('picturePreview').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('locomotiveModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
