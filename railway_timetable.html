<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Timetable - DCC Control</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            color: #2c3e50;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #2c3e50;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .header .subtitle {
            margin-top: 10px;
            font-size: 1.1em;
            opacity: 0.8;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #2980b9;
        }

        .controls .status {
            margin-left: auto;
            padding: 8px 12px;
            background-color: #27ae60;
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        .timetable-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: auto;
            margin-bottom: 20px;
            max-height: 80vh;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 800px;
        }

            .timetable th {
                background-color: #f8f9fa !important;
                color: #2c3e50 !important;
                border: 1px solid #dee2e6 !important;
            }        .timetable th.station-header {
            text-align: left;
            min-width: 150px;
            max-width: 200px;
            background-color: #e9ecef;
            position: sticky;
            left: 0;
            z-index: 101;
        }

        .timetable th.train-header {
            min-width: 80px;
            height: 70px;
            padding: 8px 4px;
        }

        .timetable td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
            font-weight: bold;
            min-height: 30px;
        }

        .timetable td.station-name {
            text-align: left;
            background-color: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .timetable td.time-cell {
            position: relative;
            vertical-align: middle;
        }

        .timetable td.time-cell.departure {
            background-color: #e8f5e8;
            border-left: 4px solid #27ae60;
        }

        .timetable td.time-cell.arrival {
            background-color: #fff3e0;
            border-left: 4px solid #f39c12;
        }

        .timetable td.time-cell.intermediate {
            background-color: #f0f8ff;
            border-left: 4px solid #3498db;
        }

        .timetable td.time-cell.empty {
            background-color: #fafafa;
            color: #bdc3c7;
        }

        .time-display {
            font-weight: bold;
            font-size: 11px;
        }

        .station-type {
            font-size: 10px;
            color: #7f8c8d;
            display: block;
            margin-top: 2px;
        }

        .train-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .train-number {
            font-weight: bold;
            font-size: 13px;
        }

        .locomotive-number {
            font-size: 9px;
            color: #bdc3c7;
            margin-top: 2px;
            font-weight: normal;
        }

        .train-type {
            font-size: 9px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .train-route {
            font-size: 8px;
            color: #95a5a6;
            max-width: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            border-left: 4px solid;
        }

        .legend-color.departure {
            background-color: #e8f5e8;
            border-left-color: #27ae60;
        }

        .legend-color.arrival {
            background-color: #fff3e0;
            border-left-color: #f39c12;
        }

        .legend-color.intermediate {
            background-color: #f0f8ff;
            border-left-color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .error {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .timetable {
                font-size: 10px;
            }
            
            .timetable th.train-header {
                min-width: 65px;
                height: 65px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                font-size: 10px;
            }
            
            .header {
                background: #2c3e50 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .controls, .stats {
                display: none;
            }
            
            .timetable th,
            .timetable td.time-cell.departure,
            .timetable td.time-cell.arrival,
            .timetable td.time-cell.intermediate {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RAILWAY TIMETABLE</h1>
        <div class="subtitle">Digital Command Control - Train Schedule</div>
    </div>

    <div class="stats" id="statsContainer">
        <div class="stat-card">
            <div class="stat-number" id="trainCount">-</div>
            <div class="stat-label">Active Trains</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="stationCount">-</div>
            <div class="stat-label">Stations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="routeCount">-</div>
            <div class="stat-label">Routes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="lastUpdate">-</div>
            <div class="stat-label">Last Updated</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="refreshTimetable()">Refresh</button>
        <button onclick="window.print()">Print</button>
        <button onclick="toggleView()">Toggle View</button>
        <button onclick="exportTimetable()">Export CSV</button>
        <div class="status" id="statusIndicator">Loading...</div>
    </div>

    <div class="timetable-container">
        <div id="loadingMessage" class="loading">Loading timetable data...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <table class="timetable" id="timetableTable" style="display: none;">
            <!-- Table content will be populated by JavaScript -->
        </table>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color departure"></div>
            <span>Departure Station</span>
        </div>
        <div class="legend-item">
            <div class="legend-color arrival"></div>
            <span>Arrival Station</span>
        </div>
        <div class="legend-item">
            <div class="legend-color intermediate"></div>
            <span>Intermediate Stop</span>
        </div>
    </div>

    <script>
        let trains = [];
        let stations = [];
        let timetableData = {};
        let currentView = 'times'; // 'times' or 'details'

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadTimetableData();
        });

        async function loadTimetableData() {
            try {
                setStatus('Loading trains...', '#f39c12');
                
                // Load trains and stations in parallel
                const [trainsResponse, stationsResponse] = await Promise.all([
                    fetch('trains_api.php?action=list&limit=100'),
                    fetch('trains_api.php?action=stations')
                ]);

                if (!trainsResponse.ok || !stationsResponse.ok) {
                    throw new Error('Failed to fetch data from server');
                }

                const trainsData = await trainsResponse.json();
                const stationsData = await stationsResponse.json();

                if (trainsData.status !== 'success' || stationsData.status !== 'success') {
                    throw new Error('Server returned error: ' + (trainsData.error || stationsData.error));
                }

                trains = trainsData.data.filter(train => 
                    train.departure_station_id && 
                    train.arrival_station_id && 
                    train.departure_time
                );
                stations = stationsData.data;

                setStatus('Loading locomotive information...', '#f39c12');
                
                // Load locomotive information for each train
                await loadLocomotiveInfo();

                setStatus('Calculating schedules...', '#3498db');
                
                // Calculate detailed schedules for each train
                await calculateDetailedSchedules();
                
                setStatus('Building timetable...', '#9b59b6');
                
                // Update statistics
                updateStats();
                
                // Build and display the timetable
                buildTimetable();
                
                setStatus(`${trains.length} trains loaded`, '#27ae60');
                
            } catch (error) {
                console.error('Error loading timetable:', error);
                showError('Failed to load timetable: ' + error.message);
                setStatus('Error loading data', '#e74c3c');
            }
        }

        async function loadLocomotiveInfo() {
            // Load locomotive information for each train
            for (let i = 0; i < trains.length; i++) {
                const train = trains[i];
                try {
                    const response = await fetch(`trains_api.php?action=get&id=${train.id}`);
                    if (response.ok) {
                        const trainData = await response.json();
                        if (trainData.status === 'success' && trainData.data.consist) {
                            train.consist = trainData.data.consist;
                            // Add lead locomotive info for quick access
                            const leadLoco = train.consist.find(loco => loco.is_lead_locomotive) || train.consist[0];
                            if (leadLoco) {
                                train.lead_locomotive = `${leadLoco.class} ${leadLoco.number}`;
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to load locomotive info for train ${train.train_number}:`, error);
                }
            }
        }

        async function calculateDetailedSchedules() {
            timetableData = {};
            
            for (const train of trains) {
                try {
                    const response = await fetch('trains_api.php?action=calculate_schedule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            departure_station_id: train.departure_station_id,
                            arrival_station_id: train.arrival_station_id,
                            departure_time: train.departure_time,
                            max_speed_kmh: train.max_speed_kmh || 80
                        })
                    });

                    if (response.ok) {
                        const scheduleData = await response.json();
                        if (scheduleData.status === 'success') {
                            timetableData[train.train_number] = {
                                train: train,
                                schedule: scheduleData.data
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to calculate schedule for train ${train.train_number}:`, error);
                    // Add basic data even if schedule calculation fails
                    timetableData[train.train_number] = {
                        train: train,
                        schedule: {
                            station_times: [
                                {
                                    station_id: train.departure_station_id,
                                    departure_time: train.departure_time,
                                    is_departure: true
                                },
                                {
                                    station_id: train.arrival_station_id,
                                    arrival_time: train.arrival_time || 'TBA',
                                    is_arrival: true
                                }
                            ]
                        }
                    };
                }
            }
        }

        function buildTimetable() {
            const table = document.getElementById('timetableTable');
            const loading = document.getElementById('loadingMessage');
            
            // Get all stations that have trains stopping
            const usedStations = new Set();
            Object.values(timetableData).forEach(trainData => {
                if (trainData.schedule && trainData.schedule.station_times) {
                    trainData.schedule.station_times.forEach(stop => {
                        usedStations.add(stop.station_id);
                    });
                }
            });

            // Filter stations to only those with trains and sort them
            const filteredStations = stations
                .filter(station => usedStations.has(station.id))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // Sort trains by departure time
            const sortedTrains = Object.values(timetableData).sort((a, b) => {
                const timeA = a.train.departure_time || '00:00';
                const timeB = b.train.departure_time || '00:00';
                return timeA.localeCompare(timeB);
            });

            // Build table header
            let headerHtml = '<tr><th class="station-header">Station</th>';
            sortedTrains.forEach(trainData => {
                const train = trainData.train;
                const route = `${train.departure_station_name || train.departure_station_id} → ${train.arrival_station_name || train.arrival_station_id}`;
                const locomotiveInfo = train.lead_locomotive || 'No loco';
                headerHtml += `
                    <th class="train-header" title="${route}">
                        <div class="train-info">
                            <div class="train-number">${train.train_number}</div>
                            <div class="locomotive-number" style="font-size: 9px; color: #bdc3c7; margin-top: 2px;">${locomotiveInfo}</div>
                        </div>
                    </th>
                `;
            });
            headerHtml += '</tr>';

            // Build table rows
            let rowsHtml = '';
            filteredStations.forEach(station => {
                rowsHtml += `<tr><td class="station-name" title="${station.description || station.name}">${station.name}</td>`;
                
                sortedTrains.forEach(trainData => {
                    const stationStop = findStationStop(trainData.schedule, station.id);
                    const cellHtml = createTimeCell(stationStop, trainData.train);
                    rowsHtml += cellHtml;
                });
                
                rowsHtml += '</tr>';
            });

            table.innerHTML = headerHtml + rowsHtml;
            table.style.display = 'table';
            loading.style.display = 'none';
        }

        function findStationStop(schedule, stationId) {
            if (!schedule || !schedule.station_times) return null;
            
            return schedule.station_times.find(stop => stop.station_id === stationId);
        }

        function createTimeCell(stationStop, train) {
            if (!stationStop) {
                return '<td class="time-cell empty">—</td>';
            }

            let timeDisplay = '';
            let cellClass = 'time-cell';
            let title = `Train ${train.train_number}`;
            
            if (stationStop.is_departure) {
                timeDisplay = formatTime(stationStop.departure_time || stationStop.arrival_time);
                cellClass += ' departure';
                title += ' - Departure';
            } else if (stationStop.is_arrival) {
                timeDisplay = formatTime(stationStop.arrival_time);
                cellClass += ' arrival';
                title += ' - Arrival';
            } else {
                // Intermediate stop - show both arrival and departure if different
                const arrTime = formatTime(stationStop.arrival_time);
                const depTime = formatTime(stationStop.departure_time);
                
                if (arrTime === depTime || !depTime) {
                    timeDisplay = arrTime;
                } else {
                    timeDisplay = `${arrTime}<br><small style="color: #666;">${depTime}</small>`;
                }
                cellClass += ' intermediate';
                title += ' - Stop';
            }

            return `<td class="${cellClass}" title="${title}">
                <div class="time-display">${timeDisplay}</div>
            </td>`;
        }

        function formatTime(timeString) {
            if (!timeString || timeString === 'TBA') return 'TBA';
            
            // Handle different time formats
            if (timeString.includes(':')) {
                const parts = timeString.split(':');
                return `${parts[0]}:${parts[1]}`;
            }
            
            return timeString;
        }

        function updateStats() {
            document.getElementById('trainCount').textContent = trains.length;
            document.getElementById('stationCount').textContent = stations.length;
            document.getElementById('routeCount').textContent = Object.keys(timetableData).length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function refreshTimetable() {
            document.getElementById('timetableTable').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            loadTimetableData();
        }

        function toggleView() {
            currentView = currentView === 'times' ? 'details' : 'times';
            buildTimetable();
            setStatus(`View: ${currentView}`, '#9b59b6');
        }

        function exportTimetable() {
            try {
                let csvContent = "Station";
                
                // Add train headers
                const sortedTrains = Object.values(timetableData).sort((a, b) => {
                    const timeA = a.train.departure_time || '00:00';
                    const timeB = b.train.departure_time || '00:00';
                    return timeA.localeCompare(timeB);
                });
                
                sortedTrains.forEach(trainData => {
                    csvContent += `,${trainData.train.train_number}`;
                });
                csvContent += "\\n";
                
                // Add station rows
                const usedStations = new Set();
                Object.values(timetableData).forEach(trainData => {
                    if (trainData.schedule && trainData.schedule.station_times) {
                        trainData.schedule.station_times.forEach(stop => {
                            usedStations.add(stop.station_id);
                        });
                    }
                });
                
                const filteredStations = stations
                    .filter(station => usedStations.has(station.id))
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                filteredStations.forEach(station => {
                    csvContent += `"${station.name}"`;
                    
                    sortedTrains.forEach(trainData => {
                        const stationStop = findStationStop(trainData.schedule, station.id);
                        let timeDisplay = '';
                        
                        if (stationStop) {
                            if (stationStop.is_departure) {
                                timeDisplay = formatTime(stationStop.departure_time || stationStop.arrival_time);
                            } else if (stationStop.is_arrival) {
                                timeDisplay = formatTime(stationStop.arrival_time);
                            } else {
                                const arrTime = formatTime(stationStop.arrival_time);
                                const depTime = formatTime(stationStop.departure_time);
                                timeDisplay = arrTime === depTime ? arrTime : `${arrTime}/${depTime}`;
                            }
                        } else {
                            timeDisplay = '';
                        }
                        
                        csvContent += `,${timeDisplay}`;
                    });
                    
                    csvContent += "\\n";
                });
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `railway_timetable_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                setStatus('Timetable exported', '#27ae60');
                
            } catch (error) {
                console.error('Export failed:', error);
                setStatus('Export failed', '#e74c3c');
            }
        }

        function setStatus(message, color = '#27ae60') {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.style.backgroundColor = color;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshTimetable, 5 * 60 * 1000);
    </script>
</body>
</html>
