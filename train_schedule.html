<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Schedule Viewer - DCC Layout Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: rgb(32, 32, 40);
            color: #e0e0e0;
            line-height: 1.6;
        }

        .header {
            background: rgb(26, 26, 32);
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
                                 <button onclick="generateBasicSchedule('${train.id}')" class="btn-secondary">
                                    🚂 Add Train
                                </button>                            <button onclick="generateBasicSchedule('${train.id}')" class="btn-secondary">
                                    🚂 Add Train
                                </button>      .header h1 {
            color: white;
            font-size: 1.5rem;
        }

        .back-link {
            color: #4fc3f7;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #4fc3f7;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: #4fc3f7;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .train-selector {
            background: rgb(45, 45, 55);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .selector-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .selector-row label {
            font-weight: 500;
            min-width: 100px;
        }

        .selector-row select, .selector-row input {
            background: rgb(65, 65, 75);
            border: 1px solid rgb(85, 85, 95);
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
            min-width: 200px;
        }

        .btn {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #29b6f6;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .schedule-container {
            background: rgb(45, 45, 55);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .schedule-header {
            background: rgb(35, 35, 45);
            padding: 20px;
            border-bottom: 1px solid rgb(65, 65, 75);
        }

        .train-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #999;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.1rem;
            color: #e0e0e0;
            font-weight: 600;
        }

        .route-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 6px;
            border-left: 4px solid #4fc3f7;
        }

        .route-path {
            font-size: 1.1rem;
            color: #4fc3f7;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .route-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .schedule-content {
            padding: 0;
        }

        .stops-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stops-table th {
            background: rgb(55, 55, 65);
            color: #e0e0e0;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgb(65, 65, 75);
        }

        .stops-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgb(65, 65, 75);
            vertical-align: middle;
        }

        .stops-table tr:hover {
            background: rgba(79, 195, 247, 0.05);
        }

        .stop-sequence {
            width: 60px;
            text-align: center;
            font-weight: 600;
            color: #4fc3f7;
        }

        .station-name {
            font-weight: 600;
            color: #e0e0e0;
        }

        .station-id {
            font-size: 0.85rem;
            color: #999;
            margin-top: 2px;
        }

        .time-cell {
            text-align: center;
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
        }

        .arrival-time {
            color: #81c784;
        }

        .departure-time {
            color: #ffb74d;
        }

        .stop-type {
            text-align: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stop-type.origin {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }

        .stop-type.destination {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
        }

        .stop-type.intermediate {
            background: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }

        .dwell-time {
            text-align: center;
            color: #999;
        }

        .track-info {
            text-align: center;
            color: #999;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            color: #e57373;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
            margin: 20px 0;
        }

        .no-schedule {
            text-align: center;
            padding: 40px;
            color: #ccc;
            background: rgb(45, 45, 55);
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-schedule h3 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.5rem;
        }

        .no-schedule h4 {
            color: #ffd700;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }

        .basic-info {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .route-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .route-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .route-point strong {
            color: #fff;
        }

        .route-point .time {
            background: #ffd700;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .route-arrow {
            font-size: 1.5rem;
            color: #ffd700;
            font-weight: bold;
        }

        .schedule-actions {
            margin: 25px 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #ffd700;
            color: #000;
        }

        .btn-primary:hover {
            background: #ffed4a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #555;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #666;
            transform: translateY(-2px);
        }

        .help-text {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 3px solid #ffd700;
            border-radius: 4px;
        }

        .help-text p {
            margin: 0;
            color: #ddd;
            font-style: italic;
        }

        .occupancy-section {
            margin-top: 20px;
            background: rgb(45, 45, 55);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .occupancy-header {
            background: rgb(35, 35, 45);
            padding: 15px 20px;
            border-bottom: 1px solid rgb(65, 65, 75);
        }

        .occupancy-header h3 {
            color: #e0e0e0;
            margin: 0;
        }

        .occupancy-content {
            padding: 20px;
        }

        .resource-block {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resource-block:last-child {
            margin-bottom: 0;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .resource-title {
            font-weight: 600;
            color: #4fc3f7;
        }

        .resource-type {
            font-size: 0.85rem;
            color: #999;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .resource-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #999;
        }

        .detail-value {
            font-weight: 600;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .selector-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .selector-row label {
                min-width: auto;
            }
            
            .selector-row select, .selector-row input {
                min-width: auto;
                width: 100%;
            }
            
            .train-info {
                grid-template-columns: 1fr;
            }
            
            .route-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .stops-table {
                font-size: 0.9rem;
            }
            
            .stops-table th, .stops-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚂 Train Schedule Viewer</h1>
        <a href="trains.html" class="back-link">← Back to Trains</a>
    </div>

    <div class="container">
        <div class="train-selector">
            <div class="selector-row">
                <label for="trainSelect">Select Train:</label>
                <select id="trainSelect">
                    <option value="">-- Select a train --</option>
                </select>
                
                <label for="dateInput">Date:</label>
                <input type="date" id="dateInput" />
                
                <button class="btn" onclick="loadSchedule()">Load Schedule</button>
                <button class="btn" onclick="refreshTrains()">Refresh Trains</button>
            </div>
        </div>

        <div id="scheduleDisplay">
            <div class="no-schedule">
                <h3>No Train Selected</h3>
                <p>Please select a train from the dropdown above to view its schedule.</p>
            </div>
        </div>
    </div>

    <script>
        let trains = [];
        let currentSchedule = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            
            // Check if train ID is passed in URL
            const urlParams = new URLSearchParams(window.location.search);
            const trainId = urlParams.get('train_id');
            
            // Load trains list and then select train if specified
            loadTrains(trainId);
        });

        async function loadTrains(autoSelectTrainId = null) {
            try {
                const response = await fetch('trains_api.php?action=list&limit=1000');
                const data = await response.json();
                
                if (data.status === 'success') {
                    trains = data.data;
                    populateTrainSelect();
                    
                    // Auto-select train if ID was provided in URL
                    if (autoSelectTrainId) {
                        console.log('Auto-selecting train ID from URL:', autoSelectTrainId);
                        selectTrainById(autoSelectTrainId);
                    }
                } else {
                    showError('Failed to load trains: ' + data.error);
                }
            } catch (error) {
                showError('Error loading trains: ' + error.message);
            }
        }

        function populateTrainSelect() {
            const select = document.getElementById('trainSelect');
            select.innerHTML = '<option value="">-- Select a train --</option>';
            
            trains.forEach(train => {
                const option = document.createElement('option');
                option.value = train.id;
                option.textContent = `${train.train_number} - ${train.train_name || 'Unnamed Train'}`;
                select.appendChild(option);
            });
        }

        function selectTrainById(trainId) {
            console.log('selectTrainById called with:', trainId, 'type:', typeof trainId);
            
            const select = document.getElementById('trainSelect');
            
            // Validate trainId
            if (!trainId || trainId === '' || trainId === '0') {
                console.error('Invalid trainId provided to selectTrainById:', trainId);
                showError('Invalid train ID provided');
                return;
            }
            
            // Check if the option exists in the select
            const option = select.querySelector(`option[value="${trainId}"]`);
            if (!option) {
                console.error('Train ID not found in dropdown:', trainId);
                showError(`Train with ID ${trainId} not found in the list. The train may be inactive or deleted.`);
                return;
            }
            
            select.value = trainId;
            loadSchedule();
        }

        async function loadSchedule() {
            const trainId = document.getElementById('trainSelect').value;
            const date = document.getElementById('dateInput').value;
            
            console.log('loadSchedule called with trainId:', trainId, 'type:', typeof trainId);
            
            if (!trainId || trainId === '' || trainId === '0') {
                showError('Please select a train');
                return;
            }
            
            // Validate trainId is a positive integer
            const trainIdInt = parseInt(trainId);
            if (isNaN(trainIdInt) || trainIdInt <= 0) {
                showError('Invalid train ID: ' + trainId);
                return;
            }
            
            const scheduleDisplay = document.getElementById('scheduleDisplay');
            scheduleDisplay.innerHTML = '<div class="loading">Loading schedule...</div>';
            
            try {
                // Get train details
                console.log('Fetching train details for ID:', trainIdInt);
                const trainResponse = await fetch(`trains_api.php?action=get&id=${trainIdInt}`);
                const trainData = await trainResponse.json();
                
                console.log('Train API response:', trainData);
                
                if (trainData.status !== 'success') {
                    throw new Error(trainData.error || 'Failed to fetch train details');
                }
                
                const train = trainData.data;
                
                // Try to get timetable schedule
                let schedule = null;
                try {
                    const scheduleResponse = await fetch(`timetable_management_api.php?action=schedules&train_id=${trainId}`);
                    const scheduleData = await scheduleResponse.json();
                    
                    if (scheduleData.status === 'success' && scheduleData.data.length > 0) {
                        schedule = scheduleData.data[0]; // Get first schedule
                        
                        // Get detailed schedule with stops only if schedule_id exists
                        if (schedule && schedule.id) {
                            const detailResponse = await fetch(`timetable_management_api.php?action=schedule&id=${schedule.id}`);
                            const detailData = await detailResponse.json();
                            
                            if (detailData.status === 'success') {
                                schedule = detailData.data;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Timetable not available:', e);
                }
                
                // Get track occupancy if available
                let occupancy = [];
                try {
                    if (schedule && schedule.id) {
                        const occupancyResponse = await fetch(`route_validator_api.php?action=get_occupancy&schedule_id=${schedule.id}&date=${date}`);
                        const occupancyData = await occupancyResponse.json();
                        
                        if (occupancyData.status === 'success') {
                            occupancy = occupancyData.data;
                        }
                    }
                } catch (e) {
                    console.warn('Occupancy data not available:', e);
                }
                
                displaySchedule(train, schedule, occupancy);
                
            } catch (error) {
                showError('Error loading schedule: ' + error.message);
            }
        }

        function displaySchedule(train, schedule, occupancy = []) {
            const scheduleDisplay = document.getElementById('scheduleDisplay');
            
            let html = `
                <div class="schedule-container">
                    <div class="schedule-header">
                        <div class="train-info">
                            <div class="info-group">
                                <div class="info-label">Train Number</div>
                                <div class="info-value">${train.train_number}</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Train Name</div>
                                <div class="info-value">${train.train_name || 'Unnamed Train'}</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Train Type</div>
                                <div class="info-value">${capitalizeFirst(train.train_type)}</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Status</div>
                                <div class="info-value">${train.is_active ? 'Active' : 'Inactive'}</div>
                            </div>
                        </div>
                        
                        <div class="route-info">
                            <div class="route-path">${train.departure_station_id || 'Unknown'} → ${train.arrival_station_id || 'Unknown'}</div>
                            <div class="route-details">
                                <div class="info-group">
                                    <div class="info-label">Departure</div>
                                    <div class="info-value">${formatTime(train.departure_time)}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Arrival</div>
                                    <div class="info-value">${formatTime(train.arrival_time)}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Route</div>
                                    <div class="info-value">${train.route || 'Direct'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-content">
            `;
            
            if (schedule && schedule.stops && schedule.stops.length > 0) {
                html += `
                    <table class="stops-table">
                        <thead>
                            <tr>
                                <th>Stop</th>
                                <th>Station</th>
                                <th>Arrival</th>
                                <th>Departure</th>
                                <th>Type</th>
                                <th>Dwell</th>
                                <th>Track</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                schedule.stops.forEach(stop => {
                    html += `
                        <tr>
                            <td class="stop-sequence">${stop.stop_sequence}</td>
                            <td>
                                <div class="station-name">${stop.station_name || stop.station_id}</div>
                                <div class="station-id">${stop.station_id}</div>
                            </td>
                            <td class="time-cell arrival-time">${formatTime(stop.arrival_time)}</td>
                            <td class="time-cell departure-time">${formatTime(stop.departure_time)}</td>
                            <td class="stop-type ${stop.stop_type}">${capitalizeFirst(stop.stop_type)}</td>
                            <td class="dwell-time">${stop.dwell_time_minutes || 0} min</td>
                            <td class="track-info">${stop.track_name || stop.track_id || 'Auto'}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html += `
                    <div class="no-schedule">
                        <h3>No Detailed Schedule Available</h3>
                        <p>This train has basic routing information but no detailed timetable schedule with stops.</p>
                        
                        <div class="basic-info">
                            <h4>Basic Route Information:</h4>
                            <div class="route-info">
                                <div class="route-point">
                                    <strong>Origin:</strong> ${train.departure_station_id}
                                    <span class="time">${formatTime(train.departure_time)}</span>
                                </div>
                                <div class="route-arrow">→</div>
                                <div class="route-point">
                                    <strong>Destination:</strong> ${train.arrival_station_id}
                                    <span class="time">${formatTime(train.arrival_time)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="schedule-actions">
                            <h4>Available Actions:</h4>
                            <div class="action-buttons">
                                <button onclick="createDetailedSchedule('${train.id}')" class="btn-primary">
                                    📅 Create Detailed Schedule
                                </button>
                                <button onclick="generateBasicSchedule('${train.id}')" class="btn-secondary">
                                    � Add Train
                                </button>
                                <button onclick="openTimetableManager('${train.id}')" class="btn-secondary">
                                    ⚙️ Open Timetable Manager
                                </button>
                            </div>
                        </div>
                        
                        <div class="help-text">
                            <p><small>💡 A detailed schedule includes intermediate stops, timing, and track assignments between the origin and destination stations.</small></p>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Add resource occupancy section if available
            if (occupancy.length > 0) {
                html += `
                    <div class="occupancy-section">
                        <div class="occupancy-header">
                            <h3>🚦 Resource Occupancy</h3>
                        </div>
                        <div class="occupancy-content">
                `;
                
                occupancy.forEach(resource => {
                    html += `
                        <div class="resource-block">
                            <div class="resource-header">
                                <div class="resource-title">${resource.station_name || resource.station_id} - ${resource.track_name || `Track ${resource.track_id}`}</div>
                                <div class="resource-type">${capitalizeFirst(resource.occupancy_type)}</div>
                            </div>
                            <div class="resource-details">
                                <div class="detail-item">
                                    <div class="detail-label">From</div>
                                    <div class="detail-value">${formatDateTime(resource.occupied_from)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Until</div>
                                    <div class="detail-value">${formatDateTime(resource.occupied_until)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Duration</div>
                                    <div class="detail-value">${calculateDuration(resource.occupied_from, resource.occupied_until)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">${resource.is_confirmed ? 'Confirmed' : 'Tentative'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            scheduleDisplay.innerHTML = html;
        }

        function showError(message) {
            const scheduleDisplay = document.getElementById('scheduleDisplay');
            scheduleDisplay.innerHTML = `<div class="error">${message}</div>`;
        }

        function refreshTrains() {
            loadTrains();
        }

        // Helper functions
        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            return timeStr.substr(0, 5); // HH:MM
        }

        function formatDateTime(datetimeStr) {
            if (!datetimeStr) return 'N/A';
            const date = new Date(datetimeStr);
            return date.toLocaleString();
        }

        function calculateDuration(from, to) {
            if (!from || !to) return 'N/A';
            const fromDate = new Date(from);
            const toDate = new Date(to);
            const diffMs = toDate - fromDate;
            const diffMins = Math.round(diffMs / 60000);
            
            if (diffMins < 60) {
                return `${diffMins} min`;
            } else {
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                return `${hours}h ${mins}m`;
            }
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Functions for schedule creation actions
        function createDetailedSchedule(trainId) {
            // Redirect to railway timetable view
            window.open(`railway_timetable.html`, '_blank');
        }

        function generateBasicSchedule(trainId) {
            // Use the Add Train feature to create a basic schedule
            window.open(`enhanced_train_generator.html?train_id=${trainId}&mode=schedule`, '_blank');
        }

        function openTimetableManager(trainId) {
            // Open the railway timetable interface
            window.open(`railway_timetable.html`, '_blank');
        }
    </script>
</body>
</html>
